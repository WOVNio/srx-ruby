#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'srx'
require 'optparse'
require 'benchmark'
require 'memory_profiler'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: #{$PROGRAM_NAME} [options]"

  opts.on('-sFILE', '--srx FILE', 'SRX file (optional)')
end.parse!(into: options)

data = if options[:srx]
         Srx::Data.from_file(path: options[:srx])
       else
         Srx::Data.default
       end
engine = Srx::Engine.new(data)

text = File.open(File.expand_path('../LICENSE.txt', __dir__), &:read).strip.then { |t| Srx::Util.unwrap(t) }

n = 1_000

report = MemoryProfiler.report do
  n.times { engine.segment(text, lang_code: 'en') }
end

report.pretty_print

Benchmark.bm do |x|
  x.report('LICENSE.txt (en)') { n.times { engine.segment(text, lang_code: 'en') } }
  x.report('LICENSE.txt (zz)') { n.times { engine.segment(text, lang_code: 'zz') } }
end
